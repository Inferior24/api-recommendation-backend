# API Contract â€” Backend Recommendation System

## Overview
This document defines the request and response contracts for the production API endpoints implemented in `backend/main.py`. Endpoints:
- POST /recommend
- POST /ask
- POST /evaluate

All responses use JSON and the canonical response envelope:
{
  "request_id": "<uuid>",
  "status": "ok" | "error",
  "error": null | { "code": "<CODE>", "message": "<human message>" },
  "payload": { ... }  // per-endpoint
}

---

## Common types
### DocumentResult (standardized)
- id: string
- similarity: float (0..1)
- doc_quality: float (normalized 0..1)
- recency: float (0..1)
- popularity: float (0..1)
- hybrid_score: float (0..1)
- metadata: object (free-form key-value map)

### Error schema
- code: string (machine readable)
- message: string (human readable)
- details?: object

---

## POST /recommend
### Purpose
Return ranked API recommendations for a given query and optional user intent.

### Request JSON
{
  "request_id": "<uuid|string optional>",
  "query": "<string>",
  "intent": "<string|null>",
  "top_k": <int, default 10>,
  "filters": { "tag": ["a","b"], "min_quality": 0.5 } // optional
}

### Response payload
{
  "query": "<string>",
  "intent": "<string|null>",
  "results": [ DocumentResult, ... ]  // length <= top_k
  "timing": { "retrieval_ms": 123, "ranking_ms": 45, "compose_ms": 10 }
}

---

## POST /ask
### Purpose
Return an answer composed from top documents + explanation for the answer.

### Request JSON
{
  "request_id": "<uuid|string optional>",
  "query": "<string>",
  "intent": "<string|null>",
  "top_k": <int, default 5>
}

### Response payload
{
  "answer": "<string>",          // composer output / explanation summary
  "source": {                    // top document used as basis
     "document": DocumentResult,
     "excerpt": "<string>"       // small snippet used in answer
  },
  "explanation": {
     "components": [
        { "name":"similarity","weight":0.6, "value":0.84 },
        { "name":"doc_quality","weight":0.2, "value":0.73 },
        ...
     ],
     "text": "<string>" // human-readable explanation generated by rag/composer.py
  },
  "timing": { "retrieval_ms": 120, "ranking_ms": 40, "compose_ms": 30 }
}

---

## POST /evaluate
### Purpose
Return evaluation metrics for a given query/ground_truth pair (used for offline evaluation).

### Request JSON
{
  "request_id": "<uuid|string optional>",
  "query": "<string>",
  "ground_truth": "<string>",
  "top_k": <int, default 10>
}

### Response payload
{
  "query": "<string>",
  "ground_truth": "<string>",
  "metrics": {
    "ndcg@k": 0.84,
    "precision@k": 0.60,
    "recall@k": 0.55
  },
  "results": [ DocumentResult, ... ],
  "timing": { "retrieval_ms": 120, "ranking_ms": 40, "eval_ms": 15 }
}

---

## Fallback / Error behaviour
- If semantic retriever is unavailable, the response must still return `results: []` plus an error object set. Example:
  status: "error",
  error: { "code": "RETRIEVER_FALLBACK", "message": "semantic retriever failed; returned fallback empty result" }
- Fallback outputs must match the `DocumentResult[]` schema (empty list acceptable).
- All timestamps must be returned in milliseconds in `timing`.

---
## Versioning
- API contract version: 1.0
- Date: YYYY-MM-DD
